(function(){"use strict";var isOSX=/Mac|PPC/.test(navigator.userAgent),ex={ex:["e.ctrlKey ^ e.metaKey","&#x2318;","Ctrl"],ctrl:["e.ctrlKey","&#x2303;","Ctrl"],alt:["e.altKey","&#x2325;","Alt"],esc:["e.keyCode == 27","&#x238B;","Esc"],shift:["e.shiftKey","&#x21E7;","Shift"]},shiftKeyCodes={"*":186,"+":187,"<":188,"=":189,">":190,"?":191,"`":192,"{":219,"|":220,"}":221,"~":222,_:226},keyCodes={":":186,";":187,",":188,"-":189,".":190,"/":191,"@":192,"[":219,"¥":220,"]":221,"^":222,"\\":226};window.menu={menus:[],eventTarget:window,start:function(e){this.eventTarget=e||window;$(this.eventTarget).off("keydown.menu").on("keydown.menu",function(e){for(var t=0,n=this.menus.length;t<n;t++){if(check(this.menus[t],e)){this.call(t,e);return false}}}.bind(this));return this},stop:function(){$(this.eventTarget).off("keydown.menu");return this},html:function(){var e="";this.menus.forEach(function(t,n){if(!t.title)return;var i=t.shortcuts.join(isOSX?"":"+");e+='<li><a href="javascript:menu.call('+n+')">'+"<span>"+escape(t.title)+"</span>";if(i.length){e+='<span class="shortcut">'+escape(i)+"</span>"}e+="</a></li>\n"});return e},call:function(e,t){var n=this.menus[e];if(n&&typeof n.callback=="function"){n.callback(t||window.event,n)}},add:function(e,t,n){if(typeof t=="function"){n=t;t=""}var i=t.split(/\+/g),r=0,o=i.length,s=[],a=[],u;for(;r<o;r++){if(ex[i[r]]){s.push(ex[i[r]][0]);a.push(isOSX?ex[i[r]][1]:ex[i[r]][2])}else if(typeof i[r]=="number"){s.push("e.keyCode==="+i[r]);a.push(String.fromCharCode(i[r]))}else if(u=/^F([12][0-9]|[1-9])/i.exec(i[r])){s.push("e.keyCode==="+(u[1]+111));a.push(u[0])}else if(keyCodes[i[r]]){s.push("!e.shiftKey");s.push("e.keyCode==="+keyCodes[i[r]]);a.push(i[r])}else if(shiftKeyCodes[i[r]]){s.push(ex.shift[0]);s.push("e.keyCode==="+shiftKeyCodes[i[r]]);a.push(i[r])}else if(typeof i[r]=="string"){if(i[r].toLowerCase()!=i[r]){s.push(ex.shift[0]);a.push(isOSX?ex.shift[1]:ex.shift[2])}else if(!~s.indexOf("e.shiftKey")){s.push("!e.shiftKey")}i[r]=i[r].substr(0,1).toUpperCase();s.push("e.keyCode==="+i[r].charCodeAt(0));a.push(i[r])}}this.menus.push({requires:s,callback:n,title:e,shortcuts:a});return this}};function check(menu,e){for(var i=0,ii=menu.requires.length;i<ii;i++){if(!eval(menu.requires[i]))return false}return!!e}function escape(e){return e.replace(/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}})();(function(){"use strict";$.event.fixHooks.drop={props:["dataTransfer"]};$._requestFullScreen=function(e){return e["requestFullscreen"]||e["webkitRequestFullscreen"]||e["mozRequestFullscreen"]||e["msRequestFullscreen"]||function(){}}(document.body);$.fn.requestFullscreen=function(){return this.each(function(){$._requestFullScreen.call(this);return false})};$.fn.getRect=function(){if(!this.length)return null;var e={};this.each(function(){var t=this.getBoundingClientRect();if(e.left!==void 0){e.left=Math.min(e.left,t.left);e.right=Math.max(e.right,t.right);e.top=Math.min(e.top,t.top);e.bottom=Math.max(e.bottom,t.bottom)}else{e={left:t.left,top:t.top,right:t.right,bottom:t.bottom}}});e.width=e.right-e.left;e.height=e.bottom-e.top;return e};toastr.options={timeOut:1500};marked.setOptions({renderer:function(e){e.listitem=function(e){if(/^\s*\[[x ]]\s*/.test(e)){e=e.replace(/^\s*\[ ]\s*/,'<input type="checkbox" class="task-list-item-checkbox"> ').replace(/^\s*\[x]\s*/,'<input type="checkbox" class="task-list-item-checkbox" checked="checked"> ');return'<li style="list-style: none">'+e+"</li>"}else{return"<li>"+e+"</li>"}};return e}(new marked.Renderer),highlight:function(e,t){return hljs.highlightAuto(e,[t]).value}});$(window).on("beforeunload",function(){return"閉じますか？"});var e=false,t=$("#workspace").on("drop",function(e){h(e["dataTransfer"].files[0],function(e){r(e)});return false}),n=$("#markdown").on("input change",function(){marked(this.value,function(t,n){if(t)return console.error(t);i.html(n).trigger("resize");e=true})}),i=$("#preview").on("resize",function(){$(".fill").each(function(){var e=$(this),t=/(?:^|\s)fill-(\S+)/.exec(this.className),n=t?$(".fill-"+t[1]).getRect():null;if(n)e.height(n.height)})}),r=function(t,i){n.val(t||"").trigger("change");if(typeof i=="boolean"){e=i}return this},o={get:function(e,t){try{var n=JSON.parse(localStorage.getItem("config"))}catch(i){}n=n||{};if(!e)return n;if(n[e]===void 0)return t;return n[e]},set:function(e,t){if(!e)return;var n=this.get();if(t===void 0){delete n[e]}else{n[e]=t}localStorage.setItem("config",JSON.stringify(n))}},s=function(e,t){if(t=t||location.search.slice(1)){var n=t.split(/&/g),i=0,r=n.length,o;for(;i<r;i++){o=n[i].split("=");if(e[o[0]])e[o[0]](decodeURIComponent(o[1]))}}};$("#menu").html(menu.start().add("Github",function(){window.open("https://github.com/HikaruYasuda/markdown-uml-js","_blank")}).add("Save","ex+s",function(){v(n.val());e=false;toastr.info("Saved.")}).add("Reload","ex+r",function(){r(m(),false);toastr.info("Reloaded.")}).add("Export...","ex+e",function(){var e=/^\s*#\s+([^\n]+)/gm.exec(n.val()),t=e?e[1]:"download";c(t+".md",n.val())}).add("Import...","ex+i",function(){l(r)}).add("Open URL...",function(){var e=prompt("Input URL for open","https://raw.githubusercontent.com/HikaruYasuda/markdown-uml-js/master/README.md");if(e)g(e)}).add("Attach Image...",function(){f(function(e){console.log(e)})}).add("V/H","ex+h",function(){t.toggleClass("vertical");o.set("vh",t.hasClass("vertical")-0)}).add("View","ex+/",function(){o.set("v",u(o.get("v",0)+1))}).add("FullScreen","ex+F",function(){t.requestFullscreen()}).html());a();function a(){var e,n=o.get("vh")-0,i=o.get("v",0);s({url:function(t){e=t},vh:function(e){n=e-0},editor:function(){i=2},preview:function(){i=1}});t.toggleClass("vertical",!!n);u(i);if(e){r("loading...\n"+e);g(e)}else{r(m(),false)}}function u(e){e=e%3;switch(e){case 0:n.show();i.show();break;case 1:n.hide();i.show();break;case 2:n.show();i.hide();break}return e}function c(e,t){var n=new Blob([t]),i=p(n),r=document.createElement("a");r.download=e;r.href=i;r.click()}function l(e){$('<input type="file">').change(function(t){h(t.target.files[0],e)}).appendTo("body").each(function(){this.click();this.parentNode.removeChild(this)})}function f(e){$('<input type="file">').change(function(t){d(t.target.files[0],e)}).appendTo("body").each(function(){this.click();this.parentNode.removeChild(this)})}function h(e,t){if(!e)return;if(e.size>1e5)return toastr.info("File size is too large. (max: 100kB)");var n=new FileReader;n.onload=function(e){t(e.target.result)};n.readAsText(e)}function d(e,t){if(!e)return;if(e.size>1e6)return toastr.info("File size is too large. (max: 1MB)");t(p(e))}function p(e){var t=window["URL"]||window["webkitURL"];return t["createObjectURL"](e)}function g(e){return $.ajax(e).then(function(t){r(t);var n=decodeURIComponent(e.split(new RegExp("/","g")).pop().split(/[\?#]/)[0]);toastr.info(n,"Loaded")},function(){r("failed\n"+e);toastr.error(e,"Load error ?")})}function m(){var e=localStorage.getItem("md")||"",t=/^(\d{13}):/.exec(e);if(t)return e.substring(t[0].length);return e}function v(e){var t=new Date-0+":";localStorage.setItem("md",t+e)}})();