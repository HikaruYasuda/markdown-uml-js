(function(){"use strict";var isOSX=/Mac|PPC/.test(navigator.userAgent),ex={ex:["e.ctrlKey ^ e.metaKey","&#x2318;","Ctrl"],ctrl:["e.ctrlKey","&#x2303;","Ctrl"],alt:["e.altKey","&#x2325;","Alt"],esc:["e.keyCode == 27","&#x238B;","Esc"],shift:["e.shiftKey","&#x21E7;","Shift"]},shiftKeyCodes={"*":186,"+":187,"<":188,"=":189,">":190,"?":191,"`":192,"{":219,"|":220,"}":221,"~":222,_:226},keyCodes={":":186,";":187,",":188,"-":189,".":190,"/":191,"@":192,"[":219,"¥":220,"]":221,"^":222,"\\":226};window.menu={menus:[],eventTarget:window,start:function(e){this.eventTarget=e||window;$(this.eventTarget).off("keydown.menu").on("keydown.menu",function(e){for(var t=0,n=this.menus.length;t<n;t++){if(check(this.menus[t],e)){this.call(t,e);return false}}}.bind(this));return this},stop:function(){$(this.eventTarget).off("keydown.menu");return this},html:function(){var e="";this.menus.forEach(function(t,n){if(!t.title)return;var i=t.shortcuts.join(isOSX?"":"+");e+='<li><a href="javascript:menu.call('+n+')">'+"<span>"+escape(t.title)+"</span>";if(i.length){e+='<span class="shortcut">'+escape(i)+"</span>"}e+="</a></li>\n"});return e},call:function(e,t){var n=this.menus[e];if(n&&typeof n.callback=="function"){n.callback(t||window.event,n)}},add:function(e,t,n){if(typeof t=="function"){n=t;t=""}var i=t.split(/\+/g),o=0,r=i.length,s=[],a=[],u;for(;o<r;o++){if(ex[i[o]]){s.push(ex[i[o]][0]);a.push(isOSX?ex[i[o]][1]:ex[i[o]][2])}else if(typeof i[o]=="number"){s.push("e.keyCode==="+i[o]);a.push(String.fromCharCode(i[o]))}else if(u=/^F([12][0-9]|[1-9])/i.exec(i[o])){s.push("e.keyCode==="+(u[1]+111));a.push(u[0])}else if(keyCodes[i[o]]){s.push("!e.shiftKey");s.push("e.keyCode==="+keyCodes[i[o]]);a.push(i[o])}else if(shiftKeyCodes[i[o]]){s.push(ex.shift[0]);s.push("e.keyCode==="+shiftKeyCodes[i[o]]);a.push(i[o])}else if(typeof i[o]=="string"){if(i[o].toLowerCase()!=i[o]){s.push(ex.shift[0]);a.push(isOSX?ex.shift[1]:ex.shift[2])}else if(!~s.indexOf("e.shiftKey")){s.push("!e.shiftKey")}i[o]=i[o].substr(0,1).toUpperCase();s.push("e.keyCode==="+i[o].charCodeAt(0));a.push(i[o])}}this.menus.push({requires:s,callback:n,title:e,shortcuts:a});return this}};function check(menu,e){for(var i=0,ii=menu.requires.length;i<ii;i++){if(!eval(menu.requires[i]))return false}return!!e}function escape(e){return e.replace(/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}})();(function(){"use strict";$.event.fixHooks.drop={props:["dataTransfer"]};$.fn.getRect=function(){if(!this.length)return null;var e={};this.each(function(){var t=this.getBoundingClientRect();if(e.left!==void 0){e.left=Math.min(e.left,t.left);e.right=Math.max(e.right,t.right);e.top=Math.min(e.top,t.top);e.bottom=Math.max(e.bottom,t.bottom)}else{e={left:t.left,top:t.top,right:t.right,bottom:t.bottom}}});e.width=e.right-e.left;e.height=e.bottom-e.top;return e};toastr.options={timeOut:1500};marked.setOptions({renderer:function(e){e.listitem=function(e){if(/^\s*\[[x ]]\s*/.test(e)){e=e.replace(/^\s*\[ ]\s*/,'<input type="checkbox" class="task-list-item-checkbox"> ').replace(/^\s*\[x]\s*/,'<input type="checkbox" class="task-list-item-checkbox" checked="checked"> ');return'<li style="list-style: none">'+e+"</li>"}else{return"<li>"+e+"</li>"}};return e}(new marked.Renderer),highlight:function(e,t){return hljs.highlightAuto(e,[t]).value}});$(window).on("beforeunload",function(){return"閉じますか？"});var e=false,t=null,n=30,i=$("#workspace").on("drop",function(e){m(e["dataTransfer"].files[0],function(e){s(e)});return false}),o=$("#markdown").on("input change",function(){if(t)clearTimeout(t);t=setTimeout(function(){marked(this.value,function(t,n){if(t)return console.error(t);r.html(n).trigger("resize");e=true})}.bind(this),n)}),r=$("#preview").on("resize",function(){$(".fill").each(function(){var e=$(this),t=/(?:^|\s)fill-(\S+)/.exec(this.className),n=t?$(".fill-"+t[1]).getRect():null;if(n)e.height(n.height)})}),s=function(t,n){o.val(t||"").trigger("change");if(typeof n=="boolean"){e=n}return this},a={get:function(e,t){try{var n=JSON.parse(localStorage.getItem("config"))}catch(i){}n=n||{};if(!e)return n;if(n[e]===void 0)return t;return n[e]},set:function(e,t){if(!e)return;var n=this.get();if(t===void 0){delete n[e]}else{n[e]=t}localStorage.setItem("config",JSON.stringify(n))}},u=function(e,t){if(t=t||location.search.slice(1)){var n=t.split(/&/g),i=0,o=n.length,r;for(;i<o;i++){r=n[i].split("=");if(e[r[0]])e[r[0]](decodeURIComponent(r[1]))}}};$("#menu").html(menu.start().add("Github",function(){window.open("https://github.com/HikaruYasuda/markdown-uml-js","_blank")}).add("Save","ex+s",function(){y(o.val());e=false;toastr.info("Saved.")}).add("Reload","ex+r",function(){s(x(),false);toastr.info("Reloaded.")}).add("Export...","ex+e",function(){var e=/^\s*#\s+([^\n]+)/gm.exec(o.val()),t=e?e[1]:"download";h(t+".md",o.val())}).add("Import...","ex+i",function(){p(s)}).add("Open URL...",function(){var e=prompt("Input URL for open","https://raw.githubusercontent.com/HikaruYasuda/markdown-uml-js/master/README.md");if(e)w(e)}).add("Attach Image...",function(){g(function(e){console.log(e)})}).add("V/H","ex+h",function(){a.set("vh",c(!c()))}).add("View","ex+/",function(){a.set("v",l(a.get("v",0)+1))}).add("Presentation","ex+P",function(){}).html());f();function f(){var e,t=a.get("vh")-0,n=a.get("v",0);u({url:function(t){e=t},vh:function(e){t=e-0},editor:function(){n=2},preview:function(){n=1}});c(t);l(n);if(e){s("loading...\n"+e);w(e)}else{s(x(),false)}}function c(e){if(e!==void 0){i.toggleClass("vertical",!!e);r.trigger("resize")}return i.hasClass("vertical")-0}function l(e){e=e%3;switch(e){case 0:o.show();r.show();break;case 1:o.hide();r.show();break;case 2:o.show();r.hide();break}r.trigger("resize");return e}function h(e,t){var n=k(new Blob([t],"text/markdown")),i=document.createElement("a");i.download=e;i.href=n;i.click()}function d(e){$('<input type="file">').change(function(t){t.target.files.length&&e(t.target.files[0])}).appendTo("body").each(function(){this.click();$(this).remove()})}function p(e){d(function(t){m(t,e)})}function g(e){d(function(t){v(t,e)})}function m(e,t){if(!e)return;if(e.size>1e5)return toastr.info("File size is too large. (max: 100kB)");var n=new FileReader;n.onload=function(e){t(e.target.result)};n.readAsText(e)}function v(e,t){if(!e)return;if(e.size>1e6)return toastr.info("File size is too large. (max: 1MB)");t(k(e))}function k(e){var t=window["URL"]||window["webkitURL"];return t["createObjectURL"](e)}function w(e){return $.ajax(e).then(function(t){s(t);var n=decodeURIComponent(e.split(new RegExp("/","g")).pop().split(/[\?#]/)[0]);toastr.info(n,"Loaded")},function(){s("failed\n"+e);toastr.error(e,"Load error ?")})}function x(){var e=localStorage.getItem("md")||"",t=/^(\d{13}):/.exec(e);if(t)return e.substring(t[0].length);return e}function y(e){var t=new Date-0+":";localStorage.setItem("md",t+e)}})();